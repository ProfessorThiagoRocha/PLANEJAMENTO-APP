<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPlan AI - Planejamento Escolar Inteligente</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0a0f1c;
            --surface: #151b2d;
            --surface-light: #1e2642;
            --primary: #6366f1;
            --text: #f1f5f9;
            --text-muted: #64748b;
            --holiday: #dc2626;
            --optional: #ea580c;
            --school: #84cc16;
            --exam: #8b5cf6;
            --weekend: #1e293b;
            --success: #10b981;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* Navigation */
        nav {
            background: var(--surface);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            background: var(--bg);
            padding: 0.25rem;
            border-radius: 0.5rem;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 0.375rem;
            transition: all 0.3s;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .nav-tab:hover {
            color: var(--text);
        }

        .nav-tab.active {
            color: var(--text);
            background: var(--surface-light);
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Calendar Header */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .calendar-title {
            font-size: 2rem;
            font-weight: 600;
        }

        .calendar-subtitle {
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .calendar-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .year-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--surface);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        .year-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg);
            color: var(--text);
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .year-btn:hover {
            background: var(--primary);
        }

        .year-display {
            font-size: 1.25rem;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--surface-light);
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-danger {
            background: rgba(220, 38, 38, 0.2);
            color: #ef4444;
            border: 1px solid rgba(220, 38, 38, 0.3);
        }

        .btn-danger:hover {
            background: rgba(220, 38, 38, 0.3);
        }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 1200px) {
            .calendar-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .calendar-grid {
                grid-template-columns: 1fr;
            }
        }

        .month-card {
            background: var(--surface);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .month-header {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2dd4bf;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .weekday {
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 0.5rem;
            font-weight: 500;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
        }

        .day-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            background: var(--school);
            color: rgba(0, 0, 0, 0.7);
            border: 2px solid transparent;
        }

        .day-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-color: white;
        }

        .day-cell.empty {
            background: transparent;
            cursor: default;
            border: none;
        }

        .day-cell.empty:hover {
            transform: none;
            box-shadow: none;
            border-color: transparent;
        }

        .day-cell.weekend {
            background: var(--weekend);
            color: var(--text-muted);
        }

        .day-cell.has-event::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 2rem;
            margin-top: 2rem;
            padding: 1rem;
            background: var(--surface);
            border-radius: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: var(--text);
            font-size: 1rem;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: flex-end;
        }

        /* Color Picker */
        .color-picker {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .color-option {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 0.5rem;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: white;
            box-shadow: 0 0 0 2px var(--primary);
        }

        .color-option.selected::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* Bulk Import Specific */
        .bulk-textarea {
            min-height: 300px;
            font-family: monospace;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .preview-list {
            max-height: 200px;
            overflow-y: auto;
            background: var(--bg);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        .preview-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.9rem;
        }

        .preview-date {
            background: var(--primary);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
        }

        /* Planning Page */
        .planning-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .planning-section {
            background: var(--surface);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .section-title {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .weekday-selector {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .weekday-option {
            padding: 1rem;
            background: var(--bg);
            border: 2px solid transparent;
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .weekday-option:hover {
            border-color: var(--primary);
        }

        .weekday-option.selected {
            background: var(--primary);
            border-color: var(--primary);
        }

        .weekday-option .day-name {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .weekday-option.selected .day-name {
            color: rgba(255, 255, 255, 0.8);
        }

        .weekday-option .day-letter {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .quantity-btn {
            width: 40px;
            height: 40px;
            border-radius: 0.5rem;
            border: none;
            background: var(--bg);
            color: var(--text);
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity-btn:hover {
            background: var(--primary);
        }

        .quantity-display {
            font-size: 1.5rem;
            font-weight: 600;
            min-width: 60px;
            text-align: center;
        }

        .content-import-area {
            background: var(--bg);
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            transition: all 0.3s;
        }

        .content-import-area:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .content-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .content-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg);
            border-radius: 0.5rem;
            border-left: 4px solid var(--primary);
        }

        .content-number {
            background: var(--primary);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .content-text {
            flex: 1;
        }

        .content-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.5rem;
        }

        .content-delete:hover {
            color: #ef4444;
        }

        /* AI Processing */
        .ai-processing {
            display: none;
            text-align: center;
            padding: 3rem;
            background: var(--surface);
            border-radius: 1rem;
            margin-bottom: 2rem;
        }

        .ai-processing.active {
            display: block;
        }

        .brain-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .processing-text {
            font-size: 1.25rem;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .processing-subtext {
            color: var(--text-muted);
        }

        .progress-bar {
            width: 100%;
            max-width: 400px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin: 2rem auto;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            width: 0%;
            animation: progress 2s ease-in-out infinite;
        }

        @keyframes progress {
            0% { width: 0%; margin-left: 0%; }
            50% { width: 50%; margin-left: 25%; }
            100% { width: 0%; margin-left: 100%; }
        }

        /* Generated Plan */
        .generated-plan {
            margin-top: 2rem;
        }

        .plan-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-box {
            background: var(--bg);
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .plan-timeline {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .timeline-item {
            display: flex;
            gap: 1rem;
            padding: 1.5rem;
            background: var(--surface);
            border-radius: 0.75rem;
            border-left: 4px solid var(--primary);
            transition: all 0.3s;
        }

        .timeline-item:hover {
            transform: translateX(5px);
            background: var(--surface-light);
        }

        .timeline-item.event-day {
            border-left-color: #f59e0b;
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.1), transparent);
        }

        .timeline-item.holiday-day {
            border-left-color: #dc2626;
            background: linear-gradient(90deg, rgba(220, 38, 38, 0.1), transparent);
        }

        .timeline-date {
            min-width: 100px;
            text-align: center;
        }

        .timeline-day {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .timeline-month {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .timeline-title {
            font-weight: 600;
            font-size: 1.1rem;
            flex: 1;
        }

        .timeline-bncc {
            font-size: 0.75rem;
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            margin-left: 1rem;
            white-space: nowrap;
        }

        .timeline-desc {
            color: var(--text-muted);
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 0.75rem;
        }

        .timeline-meta {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .meta-tag {
            font-size: 0.8rem;
            padding: 0.35rem 0.75rem;
            border-radius: 1rem;
            background: var(--bg);
            color: var(--text-muted);
        }

        .meta-tag.strategy {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary);
        }

        .meta-tag.method {
            background: rgba(6, 182, 212, 0.2);
            color: #06b6d4;
        }

        .event-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--surface);
            color: var(--text);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            border-left: 4px solid var(--primary);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 2000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .discipline-selector {
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <div class="logo">
                <span>üéì</span>
                <span>EduPlan AI</span>
            </div>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showPage('calendar')">Calend√°rio</button>
                <button class="nav-tab" onclick="showPage('planning')">Planejamento</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Calendar Page -->
        <div id="calendar-page" class="page active">
            <div class="calendar-header">
                <div>
                    <h1 class="calendar-title">Calend√°rio Escolar</h1>
                    <p class="calendar-subtitle">Clique em uma data para adicionar ou editar eventos</p>
                </div>
                <div class="calendar-actions">
                    <div class="year-selector">
                        <button class="year-btn" onclick="changeYear(-1)">‚óÄ</button>
                        <div class="year-display" id="current-year">2026</div>
                        <button class="year-btn" onclick="changeYear(1)">‚ñ∂</button>
                    </div>
                    <button class="btn btn-primary" onclick="openBulkImport()">
                        <span>üì•</span> Importar Lote
                    </button>
                    <button class="btn btn-danger" onclick="clearAllEvents()">
                        <span>üóëÔ∏è</span> Limpar
                    </button>
                </div>
            </div>

            <div id="calendar-grid" class="calendar-grid"></div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--school);"></div>
                    <span>Dia Letivo</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #dc2626;"></div>
                    <span>Feriado</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ea580c;"></div>
                    <span>Ponto Facultativo</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #8b5cf6;"></div>
                    <span>Prova/Avalia√ß√£o</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ec4899;"></div>
                    <span>Evento</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #06b6d4;"></div>
                    <span>Atividade</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--weekend);"></div>
                    <span>Fim de Semana</span>
                </div>
            </div>
        </div>

        <!-- Planning Page -->
        <div id="planning-page" class="page">
            <div class="planning-container">
                <!-- Discipline Selection -->
                <div class="planning-section">
                    <h3 class="section-title">üìñ Disciplina e Contexto</h3>
                    <div class="form-group discipline-selector">
                        <label>Selecione a disciplina (para alinhamento BNCC):</label>
                        <select id="discipline-select">
                            <option value="history">Hist√≥ria</option>
                            <option value="geography">Geografia</option>
                            <option value="math">Matem√°tica</option>
                            <option value="portuguese">L√≠ngua Portuguesa</option>
                            <option value="sciences">Ci√™ncias</option>
                            <option value="physics">F√≠sica</option>
                            <option value="chemistry">Qu√≠mica</option>
                            <option value="biology">Biologia</option>
                            <option value="philosophy">Filosofia</option>
                            <option value="sociology">Sociologia</option>
                            <option value="arts">Arte</option>
                            <option value="pe">Educa√ß√£o F√≠sica</option>
                            <option value="english">L√≠ngua Inglesa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ano/S√©rie:</label>
                        <select id="grade-select">
                            <option value="6">6¬∫ Ano (EF)</option>
                            <option value="7">7¬∫ Ano (EF)</option>
                            <option value="8">8¬∫ Ano (EF)</option>
                            <option value="9">9¬∫ Ano (EF)</option>
                            <option value="1">1¬∫ Ano (EM)</option>
                            <option value="2">2¬∫ Ano (EM)</option>
                            <option value="3">3¬∫ Ano (EM)</option>
                        </select>
                    </div>
                </div>

                <!-- Class Configuration -->
                <div class="planning-section">
                    <h3 class="section-title">‚öôÔ∏è Configura√ß√£o das Aulas</h3>
                    
                    <div class="form-group">
                        <label>Selecione os dias de aula na semana:</label>
                        <div class="weekday-selector">
                            <div class="weekday-option" onclick="toggleWeekday(0)" id="wd-0">
                                <div class="day-name">Dom</div>
                                <div class="day-letter">D</div>
                            </div>
                            <div class="weekday-option" onclick="toggleWeekday(1)" id="wd-1">
                                <div class="day-name">Seg</div>
                                <div class="day-letter">S</div>
                            </div>
                            <div class="weekday-option selected" onclick="toggleWeekday(2)" id="wd-2">
                                <div class="day-name">Ter</div>
                                <div class="day-letter">T</div>
                            </div>
                            <div class="weekday-option selected" onclick="toggleWeekday(3)" id="wd-3">
                                <div class="day-name">Qua</div>
                                <div class="day-letter">Q</div>
                            </div>
                            <div class="weekday-option selected" onclick="toggleWeekday(4)" id="wd-4">
                                <div class="day-name">Qui</div>
                                <div class="day-letter">Q</div>
                            </div>
                            <div class="weekday-option" onclick="toggleWeekday(5)" id="wd-5">
                                <div class="day-name">Sex</div>
                                <div class="day-letter">S</div>
                            </div>
                            <div class="weekday-option" onclick="toggleWeekday(6)" id="wd-6">
                                <div class="day-name">S√°b</div>
                                <div class="day-letter">S</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Aulas por dia:</label>
                        <div class="quantity-selector">
                            <button class="quantity-btn" onclick="changeQuantity(-1)">‚àí</button>
                            <div class="quantity-display" id="classes-per-day">2</div>
                            <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
                            <span style="color: var(--text-muted); margin-left: 1rem;">aulas/dia</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Per√≠odo do planejamento:</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <input type="date" id="plan-start" onchange="updatePlanPreview()">
                            <input type="date" id="plan-end" onchange="updatePlanPreview()">
                        </div>
                    </div>

                    <div id="plan-preview" style="margin-top: 1rem; padding: 1rem; background: var(--bg); border-radius: 0.5rem; display: none;">
                        <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">
                            Dias letivos dispon√≠veis: <strong id="available-days" style="color: var(--success);">0</strong> dias
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.9rem;">
                            Total de aulas poss√≠veis: <strong id="total-classes-preview" style="color: var(--primary); font-size: 1.25rem;">0</strong>
                        </div>
                    </div>
                </div>

                <!-- Content Import -->
                <div class="planning-section">
                    <h3 class="section-title">üìö Conte√∫dos Program√°ticos</h3>
                    <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">
                        A IA ir√°: <strong>expandir</strong> (se poucos conte√∫dos), <strong>agrupar</strong> (se muitos conte√∫dos) ou <strong>distribuir</strong> proporcionalmente para criar um plano completo alinhado √† BNCC.
                    </p>
                    
                    <button class="btn btn-secondary" onclick="openContentImport()" style="width: 100%; margin-bottom: 1rem;">
                        <span>üì•</span> Importar Conte√∫dos em Lote
                    </button>

                    <div id="contents-list" class="content-list">
                        <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                            Nenhum conte√∫do adicionado. Importe os conte√∫dos base.
                        </div>
                    </div>
                </div>

                <!-- Generate Button -->
                <button class="btn btn-primary" style="width: 100%; padding: 1.25rem; font-size: 1.1rem;" onclick="generatePlan()">
                    <span>ü§ñ</span> Gerar Planejamento com IA (BNCC)
                </button>

                <!-- AI Processing Animation -->
                <div class="ai-processing" id="ai-processing">
                    <div class="brain-icon">üß†</div>
                    <div class="processing-text">IA analisando e criando planejamento...</div>
                    <div class="processing-subtext" id="processing-step">Analisando conte√∫dos e disponibilidade...</div>
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                </div>

                <div id="generated-plan" class="generated-plan"></div>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div class="modal" id="event-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Adicionar Evento</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem;" id="selected-date-display"></p>
            </div>
            <div class="form-group">
                <label>Nome do Evento</label>
                <input type="text" id="event-title" placeholder="Ex: Carnaval, Prova Bimestral...">
            </div>
            <div class="form-group">
                <label>Tipo (opcional)</label>
                <select id="event-type">
                    <option value="">Personalizado</option>
                    <option value="holiday">Feriado</option>
                    <option value="optional">Ponto Facultativo</option>
                    <option value="exam">Prova/Avalia√ß√£o</option>
                    <option value="event">Evento Escolar</option>
                    <option value="activity">Atividade Especial</option>
                </select>
            </div>
            <div class="form-group">
                <label>Cor</label>
                <div class="color-picker" id="color-picker">
                    <div class="color-option selected" style="background: #dc2626;" data-color="#dc2626" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #ea580c;" data-color="#ea580c" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #84cc16;" data-color="#84cc16" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #10b981;" data-color="#10b981" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #06b6d4;" data-color="#06b6d4" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #3b82f6;" data-color="#3b82f6" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #ec4899;" data-color="#ec4899" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #6b7280;" data-color="#6b7280" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #1e293b;" data-color="#1e293b" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #ffffff;" data-color="#ffffff" onclick="selectColor(this)"></div>
                </div>
            </div>
            <div class="form-group">
                <label>Descri√ß√£o (opcional)</label>
                <input type="text" id="event-desc" placeholder="Detalhes adicionais...">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-danger" onclick="deleteEventByDate()" id="btn-delete-event" style="display: none;">Remover</button>
                <button class="btn btn-primary" onclick="saveEvent()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Bulk Import Modal -->
    <div class="modal" id="bulk-import-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>üì• Importar Eventos em Lote</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem;">
                    Formato: <code>DD/MM ‚Äì Descri√ß√£o</code> (um por linha)
                </p>
            </div>
            <textarea id="bulk-input" class="bulk-textarea" placeholder="Exemplo:
PONTO FACULTATIVO
16/02 ‚Äì Carnaval
18/02 ‚Äì Quarta-feira de Cinzas

FERIADOS
01/01 ‚Äì Confraterniza√ß√£o Universal
17/02 ‚Äì Carnaval
21/04 ‚Äì Tiradentes
01/05 ‚Äì Dia do Trabalho
07/09 ‚Äì Independ√™ncia
12/10 ‚Äì Nossa Senhora Aparecida
02/11 ‚Äì Finados
15/11 ‚Äì Proclama√ß√£o da Rep√∫blica
25/12 ‚Äì Natal"></textarea>
            
            <div id="bulk-preview" class="preview-list" style="display: none;"></div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeBulkImport()">Cancelar</button>
                <button class="btn btn-primary" onclick="previewBulk()">Pr√©-visualizar</button>
                <button class="btn btn-primary" onclick="confirmBulkImport()" id="btn-confirm-bulk" style="display: none;">
                    Confirmar Importa√ß√£o
                </button>
            </div>
        </div>
    </div>

    <!-- Content Import Modal -->
    <div class="modal" id="content-import-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>üì• Importar Conte√∫dos Base</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem;">
                    Cole os conte√∫dos program√°ticos (um por linha). A IA criar√° o detalhamento completo.
                </p>
            </div>
            <textarea id="content-input" class="bulk-textarea" placeholder="Exemplo:
Revolu√ß√£o Industrial
Imperialismo
Primeira Guerra Mundial
Crise de 1929
Segunda Guerra Mundial
Guerra Fria
Globaliza√ß√£o"></textarea>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeContentImport()">Cancelar</button>
                <button class="btn btn-primary" onclick="importContents()">Importar</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // Data
        let events = JSON.parse(localStorage.getItem('schoolEvents')) || [];
        let contents = JSON.parse(localStorage.getItem('planContents')) || [];
        let selectedDate = null;
        let selectedWeekdays = [2, 3, 4];
        let classesPerDay = 2;
        let bulkPreviewData = [];
        let currentYear = 2026;
        let selectedColor = '#dc2626';

        const months = [
            'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];

        const weekdays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];

        const typeColors = {
            holiday: '#dc2626',
            optional: '#ea580c',
            exam: '#8b5cf6',
            event: '#ec4899',
            activity: '#06b6d4',
            school: '#84cc16'
        };

        // BNCC Skills by discipline
        const bnccSkills = {
            history: ['EF06HI01', 'EF06HI02', 'EF06HI03', 'EF06HI04', 'EF06HI05', 'EF06HI06', 'EF06HI07', 'EF06HI08', 'EF06HI09', 'EF06HI10'],
            geography: ['EF06GE01', 'EF06GE02', 'EF06GE03', 'EF06GE04', 'EF06GE05', 'EF06GE06', 'EF06GE07', 'EF06GE08'],
            math: ['EF06MA01', 'EF06MA02', 'EF06MA03', 'EF06MA04', 'EF06MA05', 'EF06MA06', 'EF06MA07', 'EF06MA08', 'EF06MA09', 'EF06MA10'],
            portuguese: ['EF06LP01', 'EF06LP02', 'EF06LP03', 'EF06LP04', 'EF06LP05', 'EF06LP06', 'EF06LP07', 'EF06LP08', 'EF06LP09', 'EF06LP10'],
            sciences: ['EF06CI01', 'EF06CI02', 'EF06CI03', 'EF06CI04', 'EF06CI05', 'EF06CI06', 'EF06CI07', 'EF06CI08'],
            physics: ['EM13FIO101', 'EM13FIO102', 'EM13FIO103', 'EM13FIO104', 'EM13FIO105'],
            chemistry: ['EM13QUI101', 'EM13QUI102', 'EM13QUI103', 'EM13QUI104', 'EM13QUI105'],
            biology: ['EM13BIO101', 'EM13BIO102', 'EM13BIO103', 'EM13BIO104', 'EM13BIO105'],
            philosophy: ['EM13FIL101', 'EM13FIL102', 'EM13FIL103', 'EM13FIL104'],
            sociology: ['EM13SOC101', 'EM13SOC102', 'EM13SOC103', 'EM13SOC104'],
            arts: ['EF06AR01', 'EF06AR02', 'EF06AR03', 'EF06AR04', 'EF06AR05'],
            pe: ['EF06EF01', 'EF06EF02', 'EF06EF03', 'EF06EF04', 'EF06EF05'],
            english: ['EF06LI01', 'EF06LI02', 'EF06LI03', 'EF06LI04', 'EF06LI05']
        };

        // Teaching strategies
        const strategies = [
            'Aula expositiva dialogada',
            'Estudo de caso',
            'Resolu√ß√£o de problemas',
            'Aprendizagem baseada em projetos',
            'Gamifica√ß√£o',
            'Debate',
            'Semin√°rio',
            'Roda de conversa',
            'An√°lise de documentos',
            'Mapa conceitual',
            'Flipped classroom',
            'Aprendizagem colaborativa'
        ];

        // Methods
        const methods = [
            'Livro did√°tico',
            'Material audiovisual',
            'Textos complementares',
            'Recursos digitais',
            'Atividades pr√°ticas',
            'Pesquisa em grupo',
            'Din√¢micas',
            'Simula√ß√µes',
            'Visitas virtuais'
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const savedYear = localStorage.getItem('calendarYear');
            if (savedYear) {
                currentYear = parseInt(savedYear);
            }
            document.getElementById('current-year').textContent = currentYear;
            
            renderCalendar();
            initializePlanning();
            updateContentsList();
        });

        function initializePlanning() {
            const start = new Date(currentYear, 1, 1);
            const end = new Date(currentYear, 3, 30);
            
            document.getElementById('plan-start').value = start.toISOString().split('T')[0];
            document.getElementById('plan-end').value = end.toISOString().split('T')[0];
            
            updatePlanPreview();
        }

        function changeYear(delta) {
            currentYear += delta;
            document.getElementById('current-year').textContent = currentYear;
            localStorage.setItem('calendarYear', currentYear);
            renderCalendar();
            initializePlanning();
        }

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(page + '-page').classList.add('active');
            event.target.classList.add('active');
            
            if (page === 'calendar') renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            for (let month = 0; month < 12; month++) {
                const monthCard = createMonthCard(currentYear, month);
                grid.appendChild(monthCard);
            }
        }

        function createMonthCard(year, month) {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            
            const card = document.createElement('div');
            card.className = 'month-card';
            
            let daysHTML = '';
            
            for (let i = 0; i < startingDay; i++) {
                daysHTML += '<div class="day-cell empty"></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayOfWeek = new Date(year, month, day).getDay();
                const event = events.find(e => e.date === dateStr);
                
                let cellClass = 'day-cell';
                let title = '';
                
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    cellClass += ' weekend';
                }
                
                if (event) {
                    cellClass += ' has-event';
                    cellClass += '" style="background: ' + (event.color || typeColors[event.type] || '#dc2626') + '; color: white;';
                    title = event.title;
                } else if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    cellClass += ' school';
                }
                
                daysHTML += `<div class="${cellClass}" onclick="openEventModal('${dateStr}')" title="${title || ''}">${day}</div>`;
            }
            
            card.innerHTML = `
                <div class="month-header">${months[month]} ${year}</div>
                <div class="weekdays">
                    ${weekdays.map(d => `<div class="weekday">${d}</div>`).join('')}
                </div>
                <div class="days-grid">
                    ${daysHTML}
                </div>
            `;
            
            return card;
        }

        function openEventModal(dateStr) {
            selectedDate = dateStr;
            const date = new Date(dateStr);
            const event = events.find(e => e.date === dateStr);
            
            document.getElementById('selected-date-display').textContent = 
                date.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            
            document.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
            
            if (event) {
                document.getElementById('event-title').value = event.title;
                document.getElementById('event-type').value = event.type || '';
                document.getElementById('event-desc').value = event.description || '';
                document.getElementById('btn-delete-event').style.display = 'inline-block';
                
                const colorToSelect = event.color || typeColors[event.type] || '#dc2626';
                const colorEl = document.querySelector(`.color-option[data-color="${colorToSelect}"]`);
                if (colorEl) {
                    colorEl.classList.add('selected');
                    selectedColor = colorToSelect;
                } else {
                    document.querySelector('.color-option[data-color="#dc2626"]').classList.add('selected');
                    selectedColor = '#dc2626';
                }
            } else {
                document.getElementById('event-title').value = '';
                document.getElementById('event-type').value = '';
                document.getElementById('event-desc').value = '';
                document.getElementById('btn-delete-event').style.display = 'none';
                document.querySelector('.color-option[data-color="#dc2626"]').classList.add('selected');
                selectedColor = '#dc2626';
            }
            
            document.getElementById('event-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('event-modal').classList.remove('active');
        }

        function selectColor(element) {
            document.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
            element.classList.add('selected');
            selectedColor = element.getAttribute('data-color');
        }

        function saveEvent() {
            const title = document.getElementById('event-title').value;
            const type = document.getElementById('event-type').value;
            const description = document.getElementById('event-desc').value;
            
            if (!title) {
                showToast('Digite o nome do evento', 'error');
                return;
            }
            
            events = events.filter(e => e.date !== selectedDate);
            
            events.push({
                date: selectedDate,
                title: title,
                type: type,
                color: selectedColor,
                description: description
            });
            
            saveEvents();
            renderCalendar();
            closeModal();
            showToast('Evento salvo!');
        }

        function deleteEventByDate() {
            events = events.filter(e => e.date !== selectedDate);
            saveEvents();
            renderCalendar();
            closeModal();
            showToast('Evento removido');
        }

        function openBulkImport() {
            document.getElementById('bulk-import-modal').classList.add('active');
            document.getElementById('bulk-input').value = '';
            document.getElementById('bulk-preview').style.display = 'none';
            document.getElementById('btn-confirm-bulk').style.display = 'none';
        }

        function closeBulkImport() {
            document.getElementById('bulk-import-modal').classList.remove('active');
        }

        function previewBulk() {
            const input = document.getElementById('bulk-input').value;
            
            if (!input.trim()) {
                showToast('Cole os eventos primeiro', 'error');
                return;
            }
            
            bulkPreviewData = parseBulkEvents(input, currentYear);
            
            if (bulkPreviewData.length === 0) {
                showToast('Nenhum evento encontrado', 'error');
                return;
            }
            
            const preview = document.getElementById('bulk-preview');
            preview.innerHTML = bulkPreviewData.map(e => {
                const color = e.color || typeColors[e.type] || '#dc2626';
                return `
                    <div class="preview-item">
                        <span class="preview-date" style="background: ${color};">${e.date.split('-').reverse().join('/')}</span>
                        <span style="flex: 1;">${e.title}</span>
                    </div>
                `;
            }).join('');
            
            preview.style.display = 'block';
            document.getElementById('btn-confirm-bulk').style.display = 'inline-block';
        }

        function parseBulkEvents(input, year) {
            const lines = input.split('\n');
            const result = [];
            let currentType = 'holiday';
            let currentColor = typeColors.holiday;
            
            const typeMap = {
                'FERIADO': 'holiday',
                'FERIADOS': 'holiday',
                'FACULTATIVO': 'optional',
                'FACULTATIVOS': 'optional',
                'PONTO FACULTATIVO': 'optional',
                'PROVA': 'exam',
                'PROVAS': 'exam',
                'AVALIA√á√ÉO': 'exam',
                'EVENTO': 'event',
                'EVENTOS': 'event',
                'ATIVIDADE': 'activity',
                'ATIVIDADES': 'activity'
            };
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                const upper = line.toUpperCase();
                let foundType = null;
                
                for (const [key, value] of Object.entries(typeMap)) {
                    if (upper === key || upper.startsWith(key + ' ')) {
                        foundType = value;
                        break;
                    }
                }
                
                if (foundType && !line.match(/\d{2}\/\d{2}/)) {
                    currentType = foundType;
                    currentColor = typeColors[foundType];
                    return;
                }
                
                const match = line.match(/(\d{2})\/(\d{2})\s*[‚Äì\-]\s*(.+)/);
                if (match) {
                    const [, day, month, title] = match;
                    
                    let type = currentType;
                    let color = currentColor;
                    const lowerTitle = title.toLowerCase();
                    
                    if (lowerTitle.includes('carnaval') || lowerTitle.includes('natal') || 
                        lowerTitle.includes('ano novo') || lowerTitle.includes('tiradentes') ||
                        lowerTitle.includes('independ√™ncia') || lowerTitle.includes('aparecida') ||
                        lowerTitle.includes('finados') || lowerTitle.includes('proclama√ß√£o') ||
                        lowerTitle.includes('trabalho') || lowerTitle.includes('confraterniza√ß√£o')) {
                        type = 'holiday';
                        color = typeColors.holiday;
                    }
                    else if (lowerTitle.includes('facultativo') || lowerTitle.includes('v√©spera')) {
                        type = 'optional';
                        color = typeColors.optional;
                    }
                    else if (lowerTitle.includes('prova') || lowerTitle.includes('avalia√ß√£o')) {
                        type = 'exam';
                        color = typeColors.exam;
                    }
                    
                    result.push({
                        date: `${year}-${month}-${day}`,
                        title: title.trim(),
                        type: type,
                        color: color,
                        description: ''
                    });
                }
            });
            
            return result;
        }

        function confirmBulkImport() {
            let added = 0;
            let updated = 0;
            
            bulkPreviewData.forEach(event => {
                const existingIndex = events.findIndex(e => e.date === event.date);
                if (existingIndex >= 0) {
                    events[existingIndex] = { ...event, id: events[existingIndex].id || Date.now().toString() };
                    updated++;
                } else {
                    events.push({ ...event, id: Date.now().toString() + Math.random() });
                    added++;
                }
            });
            
            saveEvents();
            renderCalendar();
            closeBulkImport();
            showToast(`${added} eventos adicionados, ${updated} atualizados!`);
        }

        function toggleWeekday(day) {
            const index = selectedWeekdays.indexOf(day);
            const element = document.getElementById(`wd-${day}`);
            
            if (index > -1) {
                if (selectedWeekdays.length > 1) {
                    selectedWeekdays.splice(index, 1);
                    element.classList.remove('selected');
                }
            } else {
                selectedWeekdays.push(day);
                selectedWeekdays.sort((a, b) => a - b);
                element.classList.add('selected');
            }
            
            updatePlanPreview();
        }

        function changeQuantity(delta) {
            classesPerDay = Math.max(1, Math.min(10, classesPerDay + delta));
            document.getElementById('classes-per-day').textContent = classesPerDay;
            updatePlanPreview();
        }

        function updatePlanPreview() {
            const start = new Date(document.getElementById('plan-start').value);
            const end = new Date(document.getElementById('plan-end').value);
            
            if (isNaN(start) || isNaN(end)) return;
            
            let availableDays = 0;
            let totalClasses = 0;
            const current = new Date(start);
            
            while (current <= end) {
                const dayOfWeek = current.getDay();
                const dateStr = current.toISOString().split('T')[0];
                const event = events.find(e => e.date === dateStr);
                
                if (selectedWeekdays.includes(dayOfWeek)) {
                    if (!event || (event.type !== 'holiday' && event.type !== 'optional')) {
                        availableDays++;
                        totalClasses += classesPerDay;
                    }
                }
                
                current.setDate(current.getDate() + 1);
            }
            
            document.getElementById('available-days').textContent = availableDays;
            document.getElementById('total-classes-preview').textContent = totalClasses;
            document.getElementById('plan-preview').style.display = 'block';
        }

        function openContentImport() {
            document.getElementById('content-import-modal').classList.add('active');
            document.getElementById('content-input').value = '';
        }

        function closeContentImport() {
            document.getElementById('content-import-modal').classList.remove('active');
        }

        function importContents() {
            const input = document.getElementById('content-input').value;
            if (!input.trim()) {
                showToast('Cole os conte√∫dos primeiro', 'error');
                return;
            }
            
            const lines = input.split('\n').filter(l => l.trim());
            contents = []; // Reset
            lines.forEach(line => {
                contents.push({
                    id: Date.now().toString() + Math.random(),
                    text: line.trim()
                });
            });
            
            saveContents();
            updateContentsList();
            closeContentImport();
            showToast(`${lines.length} conte√∫dos importados!`);
        }

        function updateContentsList() {
            const container = document.getElementById('contents-list');
            
            if (contents.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        Nenhum conte√∫do adicionado. Importe os conte√∫dos base.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = contents.map((c, i) => `
                <div class="content-item">
                    <div class="content-number">${i + 1}</div>
                    <div class="content-text">${c.text}</div>
                    <button class="content-delete" onclick="deleteContent('${c.id}')">‚úï</button>
                </div>
            `).join('');
        }

        function deleteContent(id) {
            contents = contents.filter(c => c.id !== id);
            saveContents();
            updateContentsList();
        }

        function saveContents() {
            localStorage.setItem('planContents', JSON.stringify(contents));
        }

        // AI Plan Generation
        async function generatePlan() {
            if (contents.length === 0) {
                showToast('Adicione conte√∫dos primeiro', 'error');
                return;
            }
            
            const start = new Date(document.getElementById('plan-start').value);
            const end = new Date(document.getElementById('plan-end').value);
            const discipline = document.getElementById('discipline-select').value;
            const grade = document.getElementById('grade-select').value;
            
            if (isNaN(start) || isNaN(end)) {
                showToast('Selecione as datas do per√≠odo', 'error');
                return;
            }
            
            // Show processing animation
            document.getElementById('ai-processing').classList.add('active');
            document.getElementById('generated-plan').innerHTML = '';
            
            const steps = [
                'Analisando conte√∫dos e calend√°rio...',
                'Calculando distribui√ß√£o √≥tima...',
                'Gerando objetivos de aprendizagem...',
                'Selecionando habilidades BNCC...',
                'Criando estrat√©gias did√°ticas...',
                'Finalizando planejamento...'
            ];
            
            for (let i = 0; i < steps.length; i++) {
                document.getElementById('processing-step').textContent = steps[i];
                await sleep(800);
            }
            
            document.getElementById('ai-processing').classList.remove('active');
            
            // Get available class slots
            const classSlots = [];
            const current = new Date(start);
            
            while (current <= end) {
                const dayOfWeek = current.getDay();
                const dateStr = current.toISOString().split('T')[0];
                const event = events.find(e => e.date === dateStr);
                
                if (selectedWeekdays.includes(dayOfWeek)) {
                    if (!event || (event.type !== 'holiday' && event.type !== 'optional')) {
                        for (let i = 0; i < classesPerDay; i++) {
                            classSlots.push({
                                date: new Date(current),
                                period: i === 0 ? 'morning' : 'afternoon'
                            });
                        }
                    }
                }
                
                current.setDate(current.getDate() + 1);
            }
            
            // AI Logic: Adapt content to available slots
            const totalSlots = classSlots.length;
            const totalContents = contents.length;
            
            let plan = [];
            
            if (totalContents > totalSlots) {
                // More contents than slots: Group contents
                plan = generateConsolidatedPlan(classSlots, contents, discipline, grade);
            } else if (totalContents < totalSlots) {
                // Fewer contents than slots: Expand contents
                plan = generateExpandedPlan(classSlots, contents, discipline, grade);
            } else {
                // Equal: One per slot
                plan = generateDirectPlan(classSlots, contents, discipline, grade);
            }
            
            // Add events to plan
            const eventDays = [];
            const eventCurrent = new Date(start);
            while (eventCurrent <= end) {
                const dateStr = eventCurrent.toISOString().split('T')[0];
                const event = events.find(e => e.date === dateStr);
                if (event && (event.type === 'holiday' || event.type === 'optional' || event.type === 'exam')) {
                    eventDays.push({
                        date: new Date(eventCurrent),
                        event: event,
                        isEvent: true
                    });
                }
                eventCurrent.setDate(eventCurrent.getDate() + 1);
            }
            
            // Merge and sort
            const fullPlan = [...plan, ...eventDays].sort((a, b) => a.date - b.date);
            
            displayGeneratedPlan(fullPlan, totalSlots, totalContents);
        }

        function generateConsolidatedPlan(slots, contents, discipline, grade) {
            // Group multiple contents into single classes
            const plan = [];
            const contentsPerClass = Math.ceil(contents.length / slots.length);
            let contentIndex = 0;
            
            slots.forEach((slot, idx) => {
                const classContents = [];
                const limit = Math.min(contentIndex + contentsPerClass, contents.length);
                
                while (contentIndex < limit) {
                    classContents.push(contents[contentIndex].text);
                    contentIndex++;
                }
                
                const mainTopic = classContents[0];
                const secondaryTopics = classContents.slice(1);
                
                plan.push({
                    ...slot,
                    isEvent: false,
                    title: mainTopic + (secondaryTopics.length > 0 ? ` + ${secondaryTopics.length} tema(s)` : ''),
                    description: generateClassDescription(mainTopic, secondaryTopics, 'consolidated'),
                    objectives: generateObjectives(mainTopic, discipline, grade),
                    bncc: getRandomBNCC(discipline),
                    strategy: getRandomStrategy(),
                    method: getRandomMethod(),
                    type: 'class'
                });
            });
            
            return plan;
        }

        function generateExpandedPlan(slots, contents, discipline, grade) {
            // Expand each content into multiple classes with sub-topics
            const plan = [];
            const classesPerContent = Math.floor(slots.length / contents.length);
            const extraClasses = slots.length % contents.length;
            
            let slotIndex = 0;
            
            contents.forEach((content, idx) => {
                const isLast = idx === contents.length - 1;
                const numClasses = isLast ? (slots.length - slotIndex) : classesPerContent + (idx < extraClasses ? 1 : 0);
                
                const subTopics = generateSubTopics(content.text, numClasses);
                
                for (let i = 0; i < numClasses && slotIndex < slots.length; i++) {
                    const slot = slots[slotIndex];
                    const subTopic = subTopics[i] || `Aprofundamento em ${content.text}`;
                    
                    plan.push({
                        ...slot,
                        isEvent: false,
                        title: `${content.text}: ${subTopic}`,
                        description: generateClassDescription(content.text, [subTopic], 'expanded', i + 1, numClasses),
                        objectives: generateObjectives(content.text, discipline, grade, i + 1),
                        bncc: getRandomBNCC(discipline),
                        strategy: getRandomStrategy(),
                        method: getRandomMethod(),
                        type: 'class',
                        contentNumber: idx + 1,
                        classInContent: i + 1,
                        totalClassesInContent: numClasses
                    });
                    
                    slotIndex++;
                }
            });
            
            return plan;
        }

        function generateDirectPlan(slots, contents, discipline, grade) {
            return slots.map((slot, idx) => ({
                ...slot,
                isEvent: false,
                title: contents[idx].text,
                description: generateClassDescription(contents[idx].text, [], 'direct'),
                objectives: generateObjectives(contents[idx].text, discipline, grade),
                bncc: getRandomBNCC(discipline),
                strategy: getRandomStrategy(),
                method: getRandomMethod(),
                type: 'class'
            }));
        }

        function generateSubTopics(content, count) {
            const expansions = {
                'Revolu√ß√£o Industrial': [
                    'Contexto hist√≥rico e causas',
                    'Inven√ß√µes e inova√ß√µes tecnol√≥gicas',
                    'Transforma√ß√µes sociais e urbaniza√ß√£o',
                    'Impacto econ√¥mico mundial',
                    'Consequ√™ncias para o trabalho',
                    'Cr√≠ticas e movimentos oper√°rios'
                ],
                'Imperialismo': [
                    'Conceito e causas do expansionismo',
                    'Partilha da √Åfrica',
                    'Neocolonialismo na √Åsia',
                    'Guerras de independ√™ncia',
                    'Legados do imperialismo'
                ],
                'Primeira Guerra Mundial': [
                    'Causas e estopim do conflito',
                    'Frentes de batalha e trincheiras',
                    'Participa√ß√£o das col√¥nias',
                    'Revolu√ß√£o Russa e sa√≠da da R√∫ssia',
                    'Tratado de Versalhes e consequ√™ncias'
                ],
                'default': [
                    'Introdu√ß√£o e contextualiza√ß√£o',
                    'Desenvolvimento do tema',
                    'An√°lise cr√≠tica e debate',
                    'Aplica√ß√µes pr√°ticas',
                    'Sistematiza√ß√£o e revis√£o',
                    'Avalia√ß√£o e aprofundamento'
                ]
            };
            
            const topics = expansions[content] || expansions['default'];
            return topics.slice(0, count);
        }

        function generateClassDescription(mainTopic, secondaryTopics, mode, classNum = 1, totalClasses = 1) {
            if (mode === 'consolidated') {
                if (secondaryTopics.length === 0) {
                    return `Estudo aprofundado de ${mainTopic}. An√°lise de documentos hist√≥ricos e debate cr√≠tico sobre o tema.`;
                }
                return `Abordagem integrada de ${mainTopic} ${secondaryTopics.length > 0 ? 'com √™nfase em ' + secondaryTopics.join(', ') : ''}. Estabelecimento de rela√ß√µes entre os conceitos.`;
            } else if (mode === 'expanded') {
                const phases = ['introdu√ß√£o', 'desenvolvimento', 'aprofundamento', 'sistematiza√ß√£o', 'avalia√ß√£o'];
                const phase = phases[(classNum - 1) % phases.length];
                return `${phase.charAt(0).toUpperCase() + phase.slice(1)} do tema "${mainTopic}". Foco em ${secondaryTopics[0] || 'aspectos fundamentais'}. Atividades ${phase === 'avalia√ß√£o' ? 'de verifica√ß√£o da aprendizagem' : 'pr√°ticas e te√≥ricas'}.`;
            } else {
                return `Estudo completo de ${mainTopic}. Combina√ß√£o de exposi√ß√£o dialogada, an√°lise de fontes e atividades pr√°ticas.`;
            }
        }

        function generateObjectives(topic, discipline, grade, classNum = 1) {
            const genericObjectives = [
                'Compreender os principais conceitos e processos hist√≥ricos',
                'Analisar criticamente fontes e documentos',
                'Estabelecer rela√ß√µes entre causas e consequ√™ncias',
                'Desenvolver pensamento cr√≠tico e argumentativo',
                'Reconhecer m√∫ltiplas perspectivas hist√≥ricas',
                'Aplicar conhecimentos em situa√ß√µes diversas'
            ];
            
            return [
                genericObjectives[(classNum - 1) % genericObjectives.length],
                genericObjectives[(classNum) % genericObjectives.length]
            ];
        }

        function getRandomBNCC(discipline) {
            const skills = bnccSkills[discipline] || bnccSkills['history'];
            return skills[Math.floor(Math.random() * skills.length)];
        }

        function getRandomStrategy() {
            return strategies[Math.floor(Math.random() * strategies.length)];
        }

        function getRandomMethod() {
            return methods[Math.floor(Math.random() * methods.length)];
        }

        function displayGeneratedPlan(plan, totalSlots, totalContents) {
            const container = document.getElementById('generated-plan');
            const discipline = document.getElementById('discipline-select');
            const disciplineName = discipline.options[discipline.selectedIndex].text;
            
            // Calculate statistics
            const regularClasses = plan.filter(p => !p.isEvent).length;
            const eventDays = plan.filter(p => p.isEvent).length;
            
            let adaptationText = '';
            if (totalContents > totalSlots) {
                adaptationText = `Consolida√ß√£o: ${totalContents} conte√∫dos ‚Üí ${totalSlots} aulas`;
            } else if (totalContents < totalSlots) {
                adaptationText = `Expans√£o: ${totalContents} conte√∫dos ‚Üí ${totalSlots} aulas`;
            } else {
                adaptationText = `Distribui√ß√£o direta: 1:1`;
            }
            
            let html = `
                <div class="planning-section" style="margin-top: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h3 class="section-title" style="margin: 0;">üìã Plano de Aulas - ${disciplineName}</h3>
                            <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 0.5rem;">${adaptationText} | Alinhado √† BNCC</p>
                        </div>
                        <button class="btn btn-primary" onclick="downloadPlanPDF()">
                            <span>üìÑ</span> Baixar PDF
                        </button>
                    </div>
                    
                    <div class="plan-stats">
                        <div class="stat-box">
                            <div class="stat-value">${regularClasses}</div>
                            <div class="stat-label">Aulas Regulares</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${eventDays}</div>
                            <div class="stat-label">Eventos/Feriados</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${plan.length}</div>
                            <div class="stat-label">Total de Dias</div>
                        </div>
                    </div>
                    
                    <div class="plan-timeline">
            `;
            
            let classCounter = 1;
            
            plan.forEach((item) => {
                const monthName = months[item.date.getMonth()];
                const day = item.date.getDate();
                const weekday = weekdays[item.date.getDay()];
                
                if (item.isEvent) {
                    const eventColor = item.event.color || typeColors[item.event.type] || '#f59e0b';
                    const isHoliday = item.event.type === 'holiday';
                    
                    html += `
                        <div class="timeline-item ${isHoliday ? 'holiday-day' : 'event-day'}">
                            <div class="timeline-date">
                                <div class="timeline-day" style="color: ${eventColor};">${day}</div>
                                <div class="timeline-month">${monthName}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${weekday}</div>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <div class="timeline-title" style="color: ${eventColor};">üìÖ ${item.event.title}</div>
                                </div>
                                <div class="timeline-desc">${isHoliday ? 'N√£o haver√° aula - Feriado nacional/estadual/municipal' : 'Evento especial - Ajustar cronograma se necess√°rio'}</div>
                                <span class="event-badge" style="background: ${eventColor}20; color: ${eventColor};">
                                    ${item.event.type === 'holiday' ? 'FERIADO' : item.event.type === 'optional' ? 'PONTO FACULTATIVO' : item.event.type === 'exam' ? 'AVALIA√á√ÉO' : 'EVENTO'}
                                </span>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="timeline-item">
                            <div class="timeline-date">
                                <div class="timeline-day">${day}</div>
                                <div class="timeline-month">${monthName}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${weekday}</div>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <div class="timeline-title">Aula ${classCounter}: ${item.title}</div>
                                    <div class="timeline-bncc">BNCC: ${item.bncc}</div>
                                </div>
                                <div class="timeline-desc">${item.description}</div>
                                <div class="timeline-meta">
                                    <span class="meta-tag strategy">${item.strategy}</span>
                                    <span class="meta-tag method">${item.method}</span>
                                    ${item.classInContent ? `<span class="meta-tag">${item.classInContent}¬™ de ${item.totalClassesInContent}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    classCounter++;
                }
            });
            
            html += `</div></div>`;
            container.innerHTML = html;
            
            window.generatedPlanData = plan;
            window.planStats = { regularClasses, eventDays, total: plan.length, adaptationText, disciplineName };
        }

        function downloadPlanPDF() {
            const plan = window.generatedPlanData;
            const stats = window.planStats;
            if (!plan) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text(`Plano de Aulas - ${stats.disciplineName}`, 105, 20, { align: 'center' });
            
            doc.setFontSize(10);
            doc.text(`${stats.adaptationText}`, 20, 30);
            doc.text(`Ano: ${currentYear} | Total: ${stats.regularClasses} aulas + ${stats.eventDays} eventos`, 20, 36);
            
            const tableData = plan.map(p => {
                if (p.isEvent) {
                    return [
                        '‚Äî',
                        p.date.toLocaleDateString('pt-BR'),
                        `[${p.event.type.toUpperCase()}] ${p.event.title}`,
                        '‚Äî',
                        '‚Äî'
                    ];
                } else {
                    return [
                        `Aula ${p.classNumber || ''}`,
                        p.date.toLocaleDateString('pt-BR'),
                        p.title,
                        p.bncc,
                        p.strategy
                    ];
                }
            });
            
            doc.autoTable({
                startY: 45,
                head: [['Aula', 'Data', 'Tema/Conte√∫do', 'BNCC', 'Estrat√©gia']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [99, 102, 241] },
                styles: { fontSize: 9 },
                columnStyles: {
                    0: { cellWidth: 20 },
                    1: { cellWidth: 25 },
                    2: { cellWidth: 'auto' },
                    3: { cellWidth: 25 },
                    4: { cellWidth: 35 }
                }
            });
            
            doc.save(`plano_bncc_${currentYear}.pdf`);
            showToast('PDF baixado!');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function clearAllEvents() {
            if (confirm('Limpar todos os eventos do ano?')) {
                events = [];
                saveEvents();
                renderCalendar();
                showToast('Calend√°rio limpo');
            }
        }

        function saveEvents() {
            localStorage.setItem('schoolEvents', JSON.stringify(events));
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (type === 'error' ? ' error' : '');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        window.onclick = function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        }
    </script>
</body>
</html>